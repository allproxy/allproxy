#!/usr/bin/env bash
set -euo pipefail

DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
CA_PEM=$DIR/../.http-mitm-proxy/certs/ca.pemx
if [ ! -f $CA_PEM ]; then
    SCRIPT=$(which allproxy)
    BIN_DIR=$(dirname $SCRIPT)
    SYM_LINK_DIR=$(dirname $(readlink $SCRIPT))
    PACKAGE_DIR=$BIN_DIR/$SYM_LINK_DIR/..
    CA_PEM=$PACKAGE_DIR/.http-mitm-proxy/certs/ca.pem
fi

if [ ! -f $CA_PEM ]; then
    echo "No $CA_PEM file found!"
    echo "Execute allproxy to create the CA certificate, and try again."
    exit 1
fi

function install_linux_certs {
    read -n 1 -r -p "Look through your home directory ($HOME) for cert9.db files and add the root CA to those files? [y/n] "
    echo
    if ! [[ "$REPLY" =~ ^[Yy]$ ]]; then
        return
    fi
    if ! which certutil >/dev/null; then
        read -n 1 -r -p "You need certutil to automatically add the root CA to each browser's trust db; \"sudo apt install libnss3-tools\" now? [y/n] "
        echo
        if [[ "$REPLY" =~ ^[Yy]$ ]]; then
            sudo apt install libnss3-tools
        else
            return
        fi
    fi
    for certDB in $(find ~/ -name "cert9.db" 2>/dev/null)
    do
        echo "Adding cert to ${certDB/#$HOME/\~}"
        certdir=$(dirname ${certDB});
        certutil -A -n "AllProxy Self-Signed Root CA" -t "TCu,Cu,Tu" -i $SSLDIR/ca.pem -d sql:${certdir}
    done
    echo "You may need to restart any open browsers for this to take effect."
}

echo "Installing: $CA_PEM"

mashine="$(uname -s)"
case "$mashine" in
    Darwin*)
        if [ ! -f $(which security) ]; then
            echo "Please install the MacOS security command, and try again."
            exit 1
        fi

        echo "Adding root CA to host keychain"
        sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain $CA_PEM
        echo "If your browser still doesn't trust the CA certificate, you may need manually install it."
        ;;
   Linux*)
        install_linux_certs
        echo "If your browser still doesn't trust the CA certificate, you may need manually install it."
        ;;
    *)
        echo "Your operating system is not supported."
        echo "Please manualy install $CA_PEM"
        exit 1
        ;;
esac